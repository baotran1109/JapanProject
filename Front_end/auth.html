<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <title>Account · Explore Japan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase init -->
    <script type="module" src="/static/js/firebase-init.js?v=4"></script>
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <!-- NAV (same chrome as the rest of the site) -->
    <nav class="sticky top-0 z-50 bg-[#222] text-white">
      <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
        <div class="flex flex-wrap items-center gap-3">
          <a href="/index.html" class="font-semibold tracking-wide">Home</a>
          <a href="/itineraries.html" class="hover:underline">Recommended Itineraries</a>
          <a href="/cities.html" class="hover:underline">Explore Cities</a>
          <a href="/tips.html" class="hover:underline">Travel Tips</a>
          <a href="/my_itineraries.html" class="hover:underline">My Itineraries</a>
        </div>
        <div id="auth-mini" class="text-sm">
          <span id="auth-name" class="font-medium">Not signed in</span>
          <span class="text-white/60">·</span>
          <a href="/auth.html" id="auth-link"
             class="ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-blue-600 hover:bg-slate-100">Sign in</a>
        </div>
      </div>
      <script type="module">
        import { auth } from "/static/js/firebase-init.js?v=4";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        const nameEl = document.getElementById("auth-name");
        const linkEl = document.getElementById("auth-link");
        onAuthStateChanged(auth, (user) => {
          if (user) {
            nameEl.textContent = user.displayName || user.email;
            linkEl.textContent = "Sign out";
            linkEl.href = "#";
            linkEl.onclick = async (e) => { e.preventDefault(); await signOut(auth); };
            linkEl.className = "ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-slate-800 hover:bg-slate-100";
          } else {
            nameEl.textContent = "Not signed in";
            linkEl.textContent = "Sign in";
            linkEl.href = "/auth.html";
            linkEl.onclick = null;
            linkEl.className = "ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-blue-600 hover:bg-slate-100";
          }
        });
      </script>
    </nav>

    <!-- PAGE -->
    <main class="mx-auto max-w-md px-4 py-10">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h1 class="text-xl font-bold">Account</h1>

        <!-- Mode tabs -->
        <div class="mt-4 grid grid-cols-2 gap-1 rounded-lg bg-slate-100 p-1">
          <button id="tab-signup" class="rounded-md px-3 py-2 text-sm font-semibold bg-white shadow">Create account</button>
          <button id="tab-signin" class="rounded-md px-3 py-2 text-sm font-semibold text-slate-600">Sign in</button>
        </div>

        <!-- Form -->
        <div class="mt-5 space-y-4">
          <label class="block text-sm font-medium" for="email">Email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@example.com"
                 class="w-full rounded-xl border border-slate-300 px-3 py-2 text-[15px] outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" />

          <label class="block text-sm font-medium" for="password">Password</label>
          <div class="relative">
            <input id="password" type="password" autocomplete="current-password" placeholder="••••••••"
                   class="w-full rounded-xl border border-slate-300 px-3 py-2 text-[15px] pr-16 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100" />
            <button id="pw-toggle" type="button"
                    class="absolute inset-y-0 right-2 my-auto rounded-md px-2 text-xs font-semibold text-slate-600 hover:bg-slate-100">
              Show
            </button>
          </div>

          <button id="primary-btn"
                  class="mt-2 w-full rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-60">
            Create account
          </button>

          <div class="relative my-2">
            <div class="absolute inset-0 flex items-center"><div class="h-px w-full bg-slate-200"></div></div>
            <div class="relative flex justify-center"><span class="bg-white px-2 text-xs text-slate-500">or</span></div>
          </div>

          <button id="google-btn"
                  class="flex w-full items-center justify-center gap-2 rounded-xl bg-[#ea4335] px-4 py-2.5 text-sm font-semibold text-white hover:brightness-95 disabled:opacity-60">
            <svg width="18" height="18" viewBox="0 0 48 48" class="shrink-0"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.826 32.657 29.308 36 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.84 1.153 7.961 3.039l5.657-5.657C34.869 6.053 29.702 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20c10.493 0 19-8.507 19-19 0-1.341-.138-2.652-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.817C14.655 16.108 19.01 13 24 13c3.059 0 5.84 1.153 7.961 3.039l5.657-5.657C34.869 6.053 29.702 4 24 4 16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.243 0 10.02-2.007 13.64-5.28l-6.293-5.325C29.308 36 24.79 32.657 24 32.657c-4.99 0-9.345-3.108-11.123-7.508L6.25 30.36C9.58 36.74 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303C34.826 32.657 29.308 36 24 36c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.84 1.153 7.961 3.039l5.657-5.657C34.869 6.053 29.702 4 24 4 12.954 4 4 12.954 4 24s8.954 20 20 20c10.493 0 19-8.507 19-19 0-1.341-.138-2.652-.389-3.917z"/></svg>
            Continue with Google
          </button>

          <div class="flex items-center justify-between text-sm">
            <a href="#" id="toggle-link" class="text-slate-600 hover:underline">Already have an account? Sign in</a>
            <a href="#" id="reset-link" class="text-slate-600 hover:underline">Forgot password?</a>
          </div>

          <!-- Message area -->
          <div id="msg" role="status" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <script type="module">
      import { auth, db } from "/static/js/firebase-init.js?v=4";
      import {
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
        GoogleAuthProvider,
        signInWithPopup,
        sendEmailVerification,
        updateProfile
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
      import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

      // Elements
      const emailEl   = document.getElementById("email");
      const passEl    = document.getElementById("password");
      const pwToggle  = document.getElementById("pw-toggle");
      const primary   = document.getElementById("primary-btn");
      const googleBtn = document.getElementById("google-btn");
      const toggle    = document.getElementById("toggle-link");
      const reset     = document.getElementById("reset-link");
      const msg       = document.getElementById("msg");
      const tabSignup = document.getElementById("tab-signup");
      const tabSignin = document.getElementById("tab-signin");

      let mode = "signup"; // or "signin"

      function paintMsg(text, kind = "") {
        // kind: "", "ok", "error"
        const base = "mt-2 rounded-lg px-3 py-2 text-sm";
        if (!text) { msg.className = ""; msg.textContent = ""; return; }
        if (kind === "ok")  msg.className = base + " bg-green-50 text-green-700 border border-green-200";
        else if (kind === "error") msg.className = base + " bg-red-50 text-red-700 border border-red-200";
        else msg.className = base + " bg-slate-50 text-slate-700 border border-slate-200";
        msg.textContent = text;
      }
      function clearMsg(){ paintMsg(""); }

      function setBusy(busy) {
        [primary, googleBtn, emailEl, passEl, pwToggle].forEach(el => el.disabled = busy);
      }

      function setMode(next) {
        mode = next;
        // Button labels
        primary.textContent = (mode === "signup") ? "Create account" : "Sign in";
        toggle.textContent  = (mode === "signup") ? "Already have an account? Sign in" : "New here? Create an account";
        // Tabs
        if (mode === "signup") {
          tabSignup.className = "rounded-md px-3 py-2 text-sm font-semibold bg-white shadow";
          tabSignin.className = "rounded-md px-3 py-2 text-sm font-semibold text-slate-600";
        } else {
          tabSignin.className = "rounded-md px-3 py-2 text-sm font-semibold bg-white shadow";
          tabSignup.className = "rounded-md px-3 py-2 text-sm font-semibold text-slate-600";
        }
        clearMsg();
      }

      pwToggle.addEventListener("click", () => {
        const isPw = passEl.type === "password";
        passEl.type = isPw ? "text" : "password";
        pwToggle.textContent = isPw ? "Hide" : "Show";
        pwToggle.setAttribute("aria-label", isPw ? "Hide password" : "Show password");
      });

      toggle.addEventListener("click", (e) => {
        e.preventDefault();
        setMode(mode === "signup" ? "signin" : "signup");
      });
      tabSignup.addEventListener("click", () => setMode("signup"));
      tabSignin.addEventListener("click", () => setMode("signin"));

      reset.addEventListener("click", async (e) => {
        e.preventDefault();
        const email = emailEl.value.trim();
        if (!email) return paintMsg("Enter your email first.", "error");
        try {
          setBusy(true);
          await sendPasswordResetEmail(auth, email);
          paintMsg("Password reset email sent.", "ok");
        } catch (err) {
          paintMsg(readableError(err), "error");
        } finally {
          setBusy(false);
        }
      });

      primary.addEventListener("click", async () => {
        const email = emailEl.value.trim();
        const pass  = passEl.value;
        if (!email || !pass) return paintMsg("Email and password required.", "error");

        try {
          setBusy(true);
          if (mode === "signup") {
            paintMsg("Creating your account…");
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await updateProfile(cred.user, { displayName: email.split("@")[0] });
            await setDoc(doc(db, "users", cred.user.uid), {
              email, createdAt: serverTimestamp(), lastLogin: serverTimestamp()
            }, { merge: true });
            try { await sendEmailVerification(cred.user); } catch {}
            paintMsg("Account created. Verification email sent.", "ok");
            setTimeout(() => location.href = "/", 700);
          } else {
            paintMsg("Signing in…");
            const cred = await signInWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", cred.user.uid), { lastLogin: serverTimestamp() }, { merge: true });
            paintMsg("Welcome back!", "ok");
            setTimeout(() => history.back(), 500);
          }
        } catch (err) {
          paintMsg(readableError(err), "error");
        } finally {
          setBusy(false);
        }
      });

      googleBtn.addEventListener("click", async () => {
        try {
          setBusy(true);
          paintMsg("Opening Google…");
          const provider = new GoogleAuthProvider();
          const cred = await signInWithPopup(auth, provider);
          await setDoc(doc(db, "users", cred.user.uid), {
            email: cred.user.email,
            displayName: cred.user.displayName || "",
            provider: "google",
            lastLogin: serverTimestamp(),
            createdAt: serverTimestamp()
          }, { merge: true });
          paintMsg("Signed in with Google.", "ok");
          setTimeout(() => location.href = "/", 500);
        } catch (err) {
          paintMsg(readableError(err), "error");
        } finally {
          setBusy(false);
        }
      });

      onAuthStateChanged(auth, (user) => {
        // Keep user here; no auto-redirect to avoid confusion.
      });

      function readableError(err) {
        const code = err?.code || "";
        if (code.includes("auth/invalid-email")) return "That email looks wrong.";
        if (code.includes("auth/email-already-in-use")) return "Email is already in use.";
        if (code.includes("auth/weak-password")) return "Password is too weak (try 8+ characters).";
        if (code.includes("auth/user-not-found") || code.includes("auth/wrong-password")) return "Email or password is incorrect.";
        if (code.includes("auth/popup-closed-by-user")) return "Popup closed before completing sign in.";
        if (code.includes("auth/operation-not-allowed")) return "Sign-in method not enabled in Firebase console.";
        return err?.message || "Something went wrong.";
      }

      // default mode
      setMode("signup");
    </script>
  </body>
</html>
