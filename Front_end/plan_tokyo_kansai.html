<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Plan Your Tokyo + Kansai Trip ¬∑ Explore Japan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase init -->
  <script type="module" src="/static/js/firebase-init.js?v=4"></script>
</head>
<body class="bg-slate-50 text-slate-800 selection:bg-blue-100 selection:text-blue-900">

  <!-- NAV -->
  <nav class="sticky top-0 z-50 bg-[#222] text-white">
    <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
      <div class="flex flex-wrap items-center gap-3">
        <a href="/index.html" class="font-semibold tracking-wide">Home</a>
        <a href="/itineraries.html" class="hover:underline">Recommended Itineraries</a>
        <a href="/cities.html" class="hover:underline">Explore Cities</a>
        <a href="/tips.html" class="hover:underline">Travel Tips</a>
        <a href="/my_itineraries.html" class="hover:underline">My Itineraries</a>
      </div>

      <!-- Auth mini -->
      <div id="auth-mini" class="text-sm">
        <span id="auth-name" class="font-medium">Not signed in</span>
        <span class="text-white/60">¬∑</span>
        <a href="/auth.html" id="auth-link"
           class="ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-blue-600 hover:bg-slate-100">
          Sign in
        </a>
      </div>
    </div>

    <!-- Auth state logic -->
    <script type="module">
      import { auth } from "/static/js/firebase-init.js?v=4";
      import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
      const nameEl = document.getElementById("auth-name");
      const linkEl = document.getElementById("auth-link");
      onAuthStateChanged(auth, (user) => {
        if (user) {
          nameEl.textContent = user.displayName || user.email;
          linkEl.textContent = "Sign out";
          linkEl.href = "#";
          linkEl.onclick = async (e) => { e.preventDefault(); await signOut(auth); };
          linkEl.className = "ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-slate-800 hover:bg-slate-100";
        } else {
          nameEl.textContent = "Not signed in";
          linkEl.textContent = "Sign in";
          linkEl.href = "/auth.html";
          linkEl.onclick = null;
          linkEl.className = "ml-1 inline-block rounded-md bg-white px-2.5 py-1 font-semibold text-blue-600 hover:bg-slate-100";
        }
      });
    </script>
  </nav>

  <!-- HERO -->
  <header class="relative">
    <img src="/static/Image/japan.jpg" alt="" class="absolute inset-0 -z-10 h-56 w-full object-cover md:h-64" />
    <div class="absolute inset-0 -z-10 bg-black/35"></div>
    <div class="mx-auto max-w-6xl px-4 h-56 md:h-64 flex items-center">
      <div class="text-white">
        <h1 class="text-2xl md:text-4xl font-bold tracking-tight drop-shadow">üóº Plan Your Tokyo + Kansai (Kyoto & Osaka) Itinerary</h1>
        <p class="mt-1 text-white/90">Build your personalized trip day by day. Save to your account.</p>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-6xl px-4 py-8 grid gap-8 lg:grid-cols-[1.3fr_0.7fr]">
    <!-- LEFT: Planner -->
    <section class="space-y-6">
      <!-- Tokyo -->
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold">üìç Tokyo</h2>
          <button onclick="addDay('tokyo')" class="rounded-lg bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700">+ Add Tokyo Day</button>
        </div>
        <div id="tokyo-days" class="mt-4 space-y-4"></div>
      </div>

      <!-- Kyoto -->
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold">‚õ©Ô∏è Kyoto</h2>
          <button onclick="addDay('kyoto')" class="rounded-lg bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700">+ Add Kyoto Day</button>
        </div>
        <div id="kyoto-days" class="mt-4 space-y-4"></div>
      </div>

      <!-- Osaka -->
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold">üé° Osaka</h2>
          <button onclick="addDay('osaka')" class="rounded-lg bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700">+ Add Osaka Day</button>
        </div>
        <div id="osaka-days" class="mt-4 space-y-4"></div>
      </div>

      <!-- Custom Places (for places not in database) -->
      <div id="custom-places-section" class="rounded-2xl border border-purple-200 bg-purple-50 shadow-sm p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-xl font-semibold text-purple-900">‚ûï Add Custom Place</h2>
            <p class="text-sm text-purple-700 mt-1">Add places not in our database (hotels, friend's houses, local spots)</p>
          </div>
          <button onclick="toggleCustomPlaceForm()" class="rounded-lg bg-purple-600 px-4 py-2 text-white font-medium hover:bg-purple-700">+ New Place</button>
        </div>
        
        <!-- Add Custom Place Form -->
        <div id="custom-place-form" class="mt-4 hidden rounded-lg bg-white p-4 space-y-3">
          <div>
            <label class="block text-sm font-medium text-slate-700">Place Name *</label>
            <input id="custom-name" type="text" placeholder="e.g., Kenji's Apartment, Hidden Ramen Shop" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" required />
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700">Latitude *</label>
              <input id="custom-lat" type="number" step="0.000001" placeholder="35.6895" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" required />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Longitude *</label>
              <input id="custom-lng" type="number" step="0.000001" placeholder="139.6917" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" required />
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700">City *</label>
            <select id="custom-city" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" required>
              <option value="Tokyo">Tokyo</option>
              <option value="Kyoto">Kyoto</option>
              <option value="Osaka">Osaka</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700">Notes (optional)</label>
            <textarea id="custom-notes" placeholder="Personal notes..." class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 h-20"></textarea>
          </div>
          
          <div class="flex gap-2">
            <button onclick="saveCustomPlace()" class="flex-1 rounded-lg bg-purple-600 px-4 py-2 text-white font-medium hover:bg-purple-700">üíæ Save Place</button>
            <button onclick="toggleCustomPlaceForm()" class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-700 font-medium hover:bg-slate-50">Cancel</button>
          </div>
          
          <p class="text-xs text-slate-500">üí° Tip: Get GPS coordinates from Google Maps (right-click ‚Üí coordinates)</p>
        </div>
        
        <!-- List of User's Custom Places -->
        <div id="custom-places-list" class="mt-4 hidden">
          <h3 class="text-sm font-semibold text-purple-900 mb-2">Your Custom Places:</h3>
          <div id="custom-places-items" class="space-y-2"></div>
        </div>
      </div>

      <!-- Save + Ask AI -->
      <div class="flex flex-wrap items-center gap-3">
        <button onclick="savePlan()" class="rounded-lg bg-emerald-600 px-5 py-2.5 text-white font-semibold hover:bg-emerald-700">üíæ Save Entire Plan</button>

        <!-- NEW: Ask AI button -->
        <button id="ask-ai" class="rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-800 font-semibold hover:bg-slate-50">
          ü§ñ Ask AI to review
        </button>
        
        <button id="optimize-route-btn" class="rounded-lg bg-gradient-to-r from-green-600 to-teal-600 px-4 py-2 font-semibold text-white hover:from-green-700 hover:to-teal-700">
          üöÄ Optimize Route
        </button>

        <span id="save-msg" class="text-emerald-600 font-medium"></span>
        <button id="toggle-info" class="ml-auto rounded-lg bg-slate-900 px-4 py-2 text-white font-medium hover:bg-black lg:hidden">
          üó∫Ô∏è View Recommendations
        </button>
      </div>

      <!-- NEW: AI Review Panel -->
      <aside id="ai-panel" class="hidden rounded-2xl border border-slate-200 bg-white shadow-sm p-5">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">AI Review</h3>
          <span class="text-sm text-slate-500">Score: <span id="ai-score">‚Äî</span>/10</span>
        </div>

        <div class="grid gap-6 md:grid-cols-3 mt-3">
          <div>
            <h4 class="font-semibold">‚úÖ Strengths</h4>
            <ul id="ai-strengths" class="mt-2 list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
          </div>
          <div>
            <h4 class="font-semibold">‚ö†Ô∏è Risks</h4>
            <ul id="ai-risks" class="mt-2 list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
          </div>
          <div class="md:col-span-1"></div>
        </div>

        <div class="mt-4">
          <h4 class="font-semibold">üí° Suggestions</h4>
          <div id="ai-suggestions" class="mt-2 grid gap-3"><!-- cards injected here --></div>
        </div>
      </aside>

      <!-- Route Optimization Panel -->
      <aside id="route-panel" class="mt-6 hidden rounded-2xl border-2 border-green-200 bg-gradient-to-br from-green-50 to-teal-50 p-5 shadow-sm">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-green-900">üöÄ Optimized Route</h3>
          <div class="text-sm text-green-700">Time saved: <span id="time-saved" class="font-bold">‚Äî</span></div>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          <div class="rounded-lg bg-white p-4 shadow-sm">
            <h4 class="font-semibold text-slate-700">‚è±Ô∏è Time Breakdown</h4>
            <div class="mt-2 space-y-1 text-sm">
              <div class="flex justify-between"><span>Activities:</span> <span id="activity-time" class="font-medium">‚Äî</span></div>
              <div class="flex justify-between"><span>Travel:</span> <span id="travel-time" class="font-medium">‚Äî</span></div>
              <div class="flex justify-between border-t pt-1"><span class="font-semibold">Total:</span> <span id="total-time" class="font-bold">‚Äî</span></div>
            </div>
          </div>
          <div class="rounded-lg bg-white p-4 shadow-sm">
            <h4 class="font-semibold text-slate-700">üí¥ Cost Estimate</h4>
            <div class="mt-2 space-y-1 text-sm">
              <div class="flex justify-between"><span>Train fares:</span> <span id="cost-total" class="font-medium">‚Äî</span></div>
              <div class="flex justify-between"><span>With JR Pass:</span> <span id="cost-jr-pass" class="font-medium text-green-600">‚Äî</span></div>
              <div id="jr-pass-tip" class="mt-2 rounded bg-yellow-50 p-2 text-xs text-yellow-800"></div>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <h4 class="font-semibold text-slate-700">üìç Step-by-Step Route</h4>
          <div id="route-steps" class="mt-2 space-y-2"></div>
        </div>
        <button id="apply-optimized-route" class="mt-4 w-full rounded-lg bg-green-600 px-4 py-2 font-medium text-white hover:bg-green-700">‚úÖ Apply This Optimized Route</button>
      </aside>
    </section>

    <!-- RIGHT: Recommendations -->
    <aside id="recommendation-panel" class="hidden lg:block rounded-2xl border border-slate-200 bg-white shadow-sm p-5 h-fit">
      <div class="space-y-6">
        <!-- TOKYO -->
        <div>
          <h3 class="text-lg font-semibold">Tokyo Recommendations</h3>
          <div class="mt-2 space-y-3">
            <details class="group">
              <summary class="cursor-pointer text-blue-700 hover:underline">Top Attractions</summary>
              <ul id="tokyo-attractions" class="mt-1 list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
            </details>
            <details class="group">
              <summary class="cursor-pointer text-blue-700 hover:underline">Shopping</summary>
              <ul id="tokyo-shopping" class="mt-1 list-disc pl-5 text-sm text-slate-700 space-y-1"></ul>
            </details>
            <div class="border-t border-slate-200 pt-3">
              <h4 class="font-medium">Restaurants by Area</h4>
              <div class="mt-1 space-y-2">
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Akihabara</summary><ul id="akihabara-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Asakusa</summary><ul id="asakusa-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Ginza</summary><ul id="ginza-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Ikebukuro</summary><ul id="ikebukuro-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Meguro</summary><ul id="meguro-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Roppongi</summary><ul id="roppongi-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Shibuya</summary><ul id="shibuya-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Shinjuku</summary><ul id="shinjuku-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
                <details><summary class="cursor-pointer text-blue-700 hover:underline">Other Areas</summary><ul id="other-area-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              </div>
            </div>
            <div class="border-t border-slate-200 pt-3">
              <h4 class="font-medium">Tokyo Day Trips</h4>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Yokohama</summary><ul id="Yokohama-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Nikko</summary><ul id="Nikko-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Kamakura</summary><ul id="Kamakura-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Kawagoe</summary><ul id="Kawagoe-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Hakone</summary><ul id="Hakone-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
              <details><summary class="cursor-pointer text-blue-700 hover:underline">Mount Fuji</summary><ul id="MountFuji-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
            </div>
          </div>
        </div>

        <!-- KYOTO -->
        <div>
          <h3 class="text-lg font-semibold">Kyoto Recommendations</h3>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Top Attractions</summary><ul id="kyoto-attractions-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Shopping</summary><ul id="kyoto-shopping-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Restaurants</summary><ul id="kyoto-restaurants-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
        </div>

        <!-- OSAKA -->
        <div>
          <h3 class="text-lg font-semibold">Osaka Recommendations</h3>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Top Attractions</summary><ul id="osaka-attractions-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Shopping</summary><ul id="osaka-shopping-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          <details class="mt-1"><summary class="cursor-pointer text-blue-700 hover:underline">Restaurants</summary><ul id="osaka-restaurants-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          <div class="border-t border-slate-200 mt-3 pt-3">
            <h4 class="font-medium">Day Trips</h4>
            <details><summary class="cursor-pointer text-blue-700 hover:underline">Nara</summary><ul id="nara-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
            <h4 class="mt-3 font-medium">Kobe (day trip or 1‚Äì2 nights)</h4>
            <details><summary class="cursor-pointer text-blue-700 hover:underline">Kobe Restaurants</summary><ul id="kobe-restaurants-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
            <details><summary class="cursor-pointer text-blue-700 hover:underline">Kobe Shopping</summary><ul id="kobe-shopping-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
            <details><summary class="cursor-pointer text-blue-700 hover:underline">Kobe Attractions</summary><ul id="kobe-attractions-list" class="list-disc pl-5 text-sm text-slate-700 space-y-1 mt-1"></ul></details>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <footer class="py-10 text-center text-sm text-slate-500">&copy; 2025 Explore Japan ¬∑ Bao Tran</footer>

  <!-- Planner JS (multi-city) -->
  <script>
    const counters = { tokyo: 0, kyoto: 0, osaka: 0 };
    const cityContainer = (c)=>document.getElementById(`${c}-days`);

    function renumberCity(city){
      const boxes = cityContainer(city).querySelectorAll(".day-box");
      counters[city] = 0;
      boxes.forEach((box, idx) => {
        const n = idx + 1;
        counters[city] = n;
        box.querySelector("[data-day-label]").textContent = `Day ${n}`;
        box.querySelector(`[id^="${city}-location-"]`).id   = `${city}-location-${n}`;
        box.querySelector(`[id^="${city}-activities-"]`).id = `${city}-activities-${n}`;
        box.setAttribute("data-day", n);
      });
    }

    function removeDay(btn, city){
      const box = btn.closest(".day-box");
      if(!box) return;
      box.remove();
      renumberCity(city);
    }

    function dayCard(city, n){
      return `
        <div class="day-box rounded-xl border border-slate-200 bg-white shadow-sm p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold" data-day-label>Day ${n}</h3>
            <button type="button" onclick="removeDay(this,'${city}')" class="rounded-md bg-rose-600 px-3 py-1.5 text-white text-sm font-medium hover:bg-rose-700">Delete day</button>
          </div>
          <label class="mt-3 text-sm font-medium text-slate-700">Where to go</label>
          <input id="${city}-location-${n}" type="text" placeholder="e.g., Shibuya, Gion, Dotonbori‚Ä¶" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2" />
          <label class="mt-4 text-sm font-medium text-slate-700">Activities / Notes</label>
          <textarea id="${city}-activities-${n}" placeholder="e.g., Fushimi Inari, Namba walk, Meiji Shrine‚Ä¶" class="mt-1 w-full min-h-[110px] rounded-md border border-slate-300 px-3 py-2"></textarea>
          <label class="mt-3 text-sm font-medium text-slate-700">‚è±Ô∏è Duration for each (minutes, comma-separated)</label>
          <input id="${city}-durations-${n}" type="text" placeholder="e.g., 90, 120, 60 (default: 60 per activity)" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm" />
          <p class="mt-1 text-xs text-slate-500">üí° Separate with commas to match your activities. Leave blank for default 60 min each.</p>
        </div>`;
    }

    function addDay(city){
      counters[city]++; const n = counters[city];
      const wrap = document.createElement("div");
      wrap.innerHTML = dayCard(city, n);
      cityContainer(city).appendChild(wrap.firstElementChild);
    }
    window.addDay = addDay; window.removeDay = removeDay;

    document.getElementById("toggle-info")?.addEventListener("click", () => {
      const panel = document.getElementById("recommendation-panel");
      const showing = !panel.classList.contains("hidden");
      panel.classList.toggle("hidden", showing);
      if(!showing) window.scrollTo({ top: panel.offsetTop - 80, behavior: "smooth" });
    });

    // Create-mode default: one day per city
    window.addEventListener("load", () => {
      const params = new URLSearchParams(location.search);
      if (params.get("itineraryId")) return;
      ["tokyo","kyoto","osaka"].forEach(c => {
        cityContainer(c).innerHTML = "";
        counters[c] = 0;
        addDay(c);
      });
    });

    // Fetch helpers
    const fetchList = async (id, file) => {
      try {
        const res = await fetch(`/data/${file}`);
        if(!res.ok) throw new Error(`${file}: ${res.status}`);
        const data = await res.json();
        const ul = document.getElementById(id);
        if(!ul) return;
        for(const item of data){
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = item.google_map_url || item.google_maps_url || "#";
          a.target = "_blank";
          a.textContent = item.name || "(Unnamed)";
          a.className = "text-blue-700 hover:underline";
          li.appendChild(a);
          ul.appendChild(li);
        }
      } catch(e){ console.log("Fetch failed:", e.message || e); }
    };

    // Tokyo
    fetchList("tokyo-attractions", "Tokyo/Tokyo Attractions.json");
    fetchList("tokyo-shopping", "Tokyo/Tokyo shopping.json");
    fetchList("akihabara-list", "Tokyo/Akihabara_restaurants.json");
    fetchList("asakusa-list", "Tokyo/Asakusa_restaurants.json");
    fetchList("ginza-list", "Tokyo/Ginza_restaurants.json");
    fetchList("ikebukuro-list", "Tokyo/Ikebukuro_restaurants.json");
    fetchList("meguro-list", "Tokyo/meguro_restaurants.json");
    fetchList("shibuya-list", "Tokyo/shibuya_restaurants.json");
    fetchList("roppongi-list", "Tokyo/roppongi_restaurants.json");
    fetchList("shinjuku-list", "Tokyo/Shinjuku_restaurants.json");
    fetchList("other-area-list", "Tokyo/tokyo_other_area_restaurants.json");
    fetchList("Yokohama-list", "Tokyo/Yokohama_daytrip.json");
    fetchList("Nikko-list", "Tokyo/Nikko_daytrip.json");
    fetchList("Kamakura-list", "Tokyo/Kamakura_daytrip.json");
    fetchList("Kawagoe-list", "Tokyo/Kawagoe_daytrip.json");
    fetchList("Hakone-list", "Tokyo/Hakone_daytrip.json");
    fetchList("MountFuji-list", "Tokyo/Fujimount_daytrip.json");

    // Kyoto
    fetchList("kyoto-attractions-list", "Kyoto/Kyoto_Attractions.json");
    fetchList("kyoto-shopping-list", "Kyoto/Kyoto_Shopping.json");
    fetchList("kyoto-restaurants-list", "Kyoto/Kyoto_Restaurants.json");

    // Osaka (+ day trips)
    fetchList("osaka-attractions-list", "Osaka/Osaka_Attractions.json");
    fetchList("osaka-shopping-list", "Osaka/Osaka_Shopping.json");
    fetchList("osaka-restaurants-list", "Osaka/Osaka_Restaurants.json");
    fetchList("nara-list","Osaka/Nara_day_trip.json");
    fetchList("kobe-restaurants-list","Osaka/Kobe_restaurants.json");
    fetchList("kobe-shopping-list","Osaka/Kobe_Shopping.json");
    fetchList("kobe-attractions-list","Osaka/Kobe_Attractions.json");
  </script>

  <!-- ===== Ask AI Review (Tokyo / Kyoto / Osaka) ===== -->
  <script>
    // --- Collect plan (strip days with no text at all) ---
    function collectPlanForAI(){
      const regions = ["tokyo","kyoto","osaka"];
      const out = {};
      regions.forEach(r=>{
        const boxes = document.querySelectorAll(`#${r}-days .day-box`);
        const days = [];
        boxes.forEach((box,i)=>{
          const loc = box.querySelector(`[id^="${r}-location-"]`)?.value.trim() || "";
          const act = box.querySelector(`[id^="${r}-activities-"]`)?.value.trim() || "";
          if (loc || act){
            days.push({ day:i+1, location:loc, activities:act });
          }
        });
        if (days.length) out[r] = days;
      });
      return out;
    }

    // --- Helpers to find fields & text ops ---
    function findFields(region, day){
      const loc = document.getElementById(`${region}-location-${day}`);
      const act = document.getElementById(`${region}-activities-${day}`);
      return {loc, act};
    }
    const escRe = (s)=>String(s||"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
    function includesToken(text, token){
      return (text||"").toLowerCase().includes(String(token||"").toLowerCase());
    }
    function removeOnce(text, token){
      if(!text || !token) return text||"";
      const re = new RegExp(escRe(token), "i");
      // also clean up leftover separators like " / / "
      return text
        .replace(re, "")
        .replace(/\s{2,}/g," ")
        .replace(/\s*(\/|[|;,])\s*(\/|[|;,])\s*/g,"$1 ")
        .replace(/^\s*(\/|[|;,])\s*|\s*(\/|[|;,])\s*$/g,"")
        .trim();
    }

    // --- Apply micro-edits coming from AI ---
    function ensureDayExists(region, day){
      while(!document.getElementById(`${region}-activities-${day}`)){
        addDay(region);
      }
    }
    function applyMove(region, item, fromDay, toDay){
      ensureDayExists(region, toDay);
      const from = findFields(region, fromDay);
      const to   = findFields(region, toDay);
      if(!from.act || !to.act) return alert("Day not found in UI.");

      // remove from source (try activities, then location)
      if (includesToken(from.act.value, item)){
        from.act.value = removeOnce(from.act.value, item);
      } else if (from.loc && includesToken(from.loc.value, item)){
        from.loc.value = removeOnce(from.loc.value, item);
      }

      // append to target activities
      const glue = to.act.value.trim() ? " / " : "";
      to.act.value = `${to.act.value.trim()}${glue}${item}`.trim();
    }
    function applySwap(region, a, b, day){
      const {act, loc} = findFields(region, day);
      if(!act) return alert("Day not found.");
      const reA = new RegExp(escRe(a), "i");
      const reB = new RegExp(escRe(b), "i");
      let t = act.value;
      if (reA.test(t) && reB.test(t)){
        t = t.replace(reA,"__TMP__");
        t = t.replace(reB,a);
        t = t.replace(/__TMP__/g,b);
        act.value = t;
      }
      if (loc){
        const hasA = new RegExp(escRe(a), "i").test(loc.value);
        const hasB = new RegExp(escRe(b), "i").test(loc.value);
        if (hasA && !hasB) loc.value = loc.value.replace(new RegExp(escRe(a), "i"), b);
        else if (hasB && !hasA) loc.value = loc.value.replace(new RegExp(escRe(b), "i"), a);
      }
    }
    function applyTrim(region, item, day){
      const {act, loc} = findFields(region, day);
      if(!act) return alert("Day not found.");
      act.value = removeOnce(act.value, item);
      if (loc) loc.value = removeOnce(loc.value, item);
    }
    function applySuggestion(s){
      const region = String(s.region||"").toLowerCase();
      const day = parseInt(s.day,10);
      const d = s.details || {};
      if(!region || !day || !d) return alert("Invalid suggestion.");
      if (s.action === "move")  return applyMove(region, d.item, day, d.toDay);
      if (s.action === "swap")  return applySwap(region, d.a, d.b, day);
      if (s.action === "trim")  return applyTrim(region, d.item, day);
      alert("Unsupported suggestion.");
    }

    // --- Render AI review into panel ---
    function renderReview(r){
      const panel = document.getElementById("ai-panel");
      panel.classList.remove("hidden");

      document.getElementById("ai-score").textContent =
        (typeof r.overallScore === "number" ? r.overallScore : "‚Äî");

      const strengthsEl = document.getElementById("ai-strengths");
      const risksEl = document.getElementById("ai-risks");
      const suggsEl = document.getElementById("ai-suggestions");
      strengthsEl.innerHTML = ""; risksEl.innerHTML = ""; suggsEl.innerHTML = "";

      (r.strengths||[]).forEach(t=>{
        const li = document.createElement("li");
        li.textContent = t;
        strengthsEl.appendChild(li);
      });
      (r.risks||[]).forEach(t=>{
        const li = document.createElement("li");
        li.textContent = t;
        risksEl.appendChild(li);
      });

      (r.suggestions||[]).forEach((s)=>{
        const card = document.createElement("div");
        card.className = "rounded-xl border border-slate-200 p-4";

        const header = document.createElement("div");
        header.className = "flex items-start justify-between gap-3";
        const h = document.createElement("div");
        h.innerHTML = `<div class="font-semibold">${s.title || "Suggested minor edit"}</div>
                       <div class="text-xs text-slate-500">${(s.region||"").toUpperCase()} ‚Ä¢ Day ${s.day} ‚Ä¢ ${s.action}</div>`;
        header.appendChild(h);

        const conf = document.createElement("div");
        conf.className = "text-xs text-slate-500";
        const pct = Math.round((s.confidence ?? 0)*100);
        conf.textContent = `${pct}%`;
        header.appendChild(conf);
        card.appendChild(header);

        const reason = document.createElement("p");
        reason.className = "mt-2 text-sm text-slate-700";
        reason.textContent = s.reason || "";
        card.appendChild(reason);

        if (s.impact){
          const imp = document.createElement("p");
          imp.className = "mt-1 text-xs text-slate-500";
          imp.textContent = `Impact: ${s.impact}`;
          card.appendChild(imp);
        }

        const btn = document.createElement("button");
        btn.className = "mt-3 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm font-semibold hover:bg-slate-50";
        btn.textContent = "Apply this suggestion";
        btn.onclick = ()=> applySuggestion(s);
        card.appendChild(btn);

        suggsEl.appendChild(card);
      });

      if(!r.suggestions || r.suggestions.length===0){
        const empty = document.createElement("div");
        empty.className = "text-sm text-slate-500";
        empty.textContent = "No concrete micro-edits needed.";
        suggsEl.appendChild(empty);
      }

      panel.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // --- Wire up Ask AI button ---
    document.getElementById("ask-ai")?.addEventListener("click", async ()=>{
      try{
        const plan = collectPlanForAI();
        if (Object.keys(plan).length === 0){
          alert("Add at least one day with a location or activity before requesting an AI review.");
          return;
        }
        const res = await fetch("/ai/review", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ plan })
        });
        if (!res.ok){
          let msg = `HTTP ${res.status}`;
          try{ const j = await res.json(); if (j?.error) msg = j.error; }catch{}
          throw new Error(msg);
        }
        const review = await res.json();
        renderReview(review);
      }catch(e){
        console.error(e);
        alert("AI review failed: " + (e?.message || e));
      }
    });

    // Route Optimization with DP
    let optimizedRouteData = null;
    document.getElementById("optimize-route-btn")?.addEventListener("click", async () => {
      try {
        // Group locations by city (don't mix cities!)
        const locationsByCity = {Tokyo: [], Kyoto: [], Osaka: []};
        const cityMap = {tokyo: 'Tokyo', kyoto: 'Kyoto', osaka: 'Osaka'};
        
        for (const [cityKey, cityName] of Object.entries(cityMap)) {
          const boxes = document.querySelectorAll(`#${cityKey}-days .day-box`);
          boxes.forEach(box => {
            const location = box.querySelector(`input[id^="${cityKey}-location-"]`)?.value.trim();
            const activities = box.querySelector(`textarea[id^="${cityKey}-activities-"]`)?.value.trim();
            const durationsInput = box.querySelector(`input[id^="${cityKey}-durations-"]`)?.value.trim();
            
            // Parse durations (comma-separated)
            const durationValues = durationsInput 
              ? durationsInput.split(',').map(d => parseInt(d.trim()) || 60)
              : [];
            
            // Add main location with first duration
            if (location) {
              locationsByCity[cityName].push({
                name: location, 
                duration: durationValues[0] || 60, 
                city: cityName
              });
            }
            
            // Add activities with their corresponding durations
            if (activities) {
              const acts = activities.split(/[/,;\n]/).map(a => a.trim()).filter(a => a);
              acts.forEach((act, actIndex) => {
                // Get duration for this activity (offset by 1 if location exists)
                const durationIndex = location ? actIndex + 1 : actIndex;
                locationsByCity[cityName].push({
                  name: act, 
                  duration: durationValues[durationIndex] || 60, 
                  city: cityName
                });
              });
            }
          });
        }
        
        // Optimize each city separately
        const cityResults = [];
        for (const [cityName, locs] of Object.entries(locationsByCity)) {
          if (locs.length === 0) continue;
          
          // Enrich with GPS from MongoDB
          const enriched = [];
          console.log(`üîç Searching for locations in ${cityName}:`, locs.map(l => l.name));
          
          for (const loc of locs) {
            try {
              // Use /search/combined to include user's custom places
              const searchUrl = `/search/combined?q=${encodeURIComponent(loc.name)}&limit=10`;
              const searchHeaders = currentUserId ? { "X-User-ID": currentUserId } : {};
              const searchRes = await fetch(searchUrl, { headers: searchHeaders });
              const searchData = await searchRes.json();
              
              let allResults = [
                ...(searchData.attractions || []), 
                ...(searchData.restaurants || []), 
                ...(searchData.shopping || [])
              ];
              
              console.log(`  üìç "${loc.name}" - Found ${allResults.length} total results`);
              
              // Filter to correct city
              allResults = allResults.filter(r => r.city === loc.city);
              console.log(`  ‚úì After city filter (${loc.city}): ${allResults.length} results`);
              
              if (allResults.length > 0 && allResults[0].lat && allResults[0].lng) {
                enriched.push({name: loc.name, lat: allResults[0].lat, lng: allResults[0].lng, duration: loc.duration});
                console.log(`  ‚úÖ Added: ${loc.name} at (${allResults[0].lat}, ${allResults[0].lng})`);
              } else {
                console.warn(`  ‚ö†Ô∏è No coordinates found for "${loc.name}" in ${loc.city}`);
              }
            } catch (err) {
              console.error(`  ‚ùå Error searching for ${loc.name}:`, err);
            }
          }
          
          console.log(`‚úÖ ${cityName}: ${enriched.length}/${locs.length} locations have coordinates`);
          
          // Only optimize if we have 2+ locations with coordinates
          if (enriched.length >= 2) {
            const res = await fetch("/optimize-route", {
              method: "POST", 
              headers: {"Content-Type": "application/json"}, 
              body: JSON.stringify({locations: enriched, start_index: 0, has_jr_pass: true})  // Always calculate JR Pass
            });
            
            if (res.ok) {
              const optimized = await res.json();
              cityResults.push({city: cityName, ...optimized});
              console.log(`‚úÖ ${cityName} optimized:`, optimized);
            } else {
              console.error(`‚ùå ${cityName} optimization failed: HTTP ${res.status}`);
            }
          } else {
            console.warn(`‚ö†Ô∏è ${cityName}: Not enough locations with coordinates (need 2+, have ${enriched.length})`);
            if (enriched.length === 1) {
              alert(`${cityName}: Only found 1 location with GPS. Need at least 2 to optimize.\nMissing: ${locs.filter(l => !enriched.find(e => e.name === l.name)).map(l => l.name).join(', ')}`);
            } else if (enriched.length === 0) {
              alert(`${cityName}: No locations found in database. Try:\n- "Senso-ji Temple" (not just "Senso-ji")\n- "Tokyo Skytree"\n- "Shibuya Crossing"`);
            }
          }
        }
        
        if (cityResults.length === 0) {
          alert("Could not find GPS coordinates for your locations. Try using specific place names like 'Senso-ji Temple' or 'Tokyo Skytree'.");
          return;
        }
        
        // Combine results and render
        optimizedRouteData = cityResults;
        
        const panel = document.getElementById("route-panel");
        panel.classList.remove("hidden");
        
        // Calculate totals across all cities
        const totalTimeSaved = cityResults.reduce((sum, city) => sum + city.time_saved, 0);
        const totalActivityTime = cityResults.reduce((sum, city) => sum + city.total_activity_time, 0);
        const totalTravelTime = cityResults.reduce((sum, city) => sum + city.total_travel_time, 0);
        const totalTime = totalActivityTime + totalTravelTime;
        // Calculate totals with new accurate cost structure
        const totalCost = cityResults.reduce((sum, city) => sum + city.cost_estimate.total_without_pass, 0);
        const totalCostJR = cityResults.reduce((sum, city) => sum + city.cost_estimate.total_with_pass, 0);
        const totalSavings = totalCost - totalCostJR;
        const isWorthIt = cityResults.some(city => city.cost_estimate.is_worth_it);
        
        // Update summary stats
        document.getElementById("time-saved").textContent = `${totalTimeSaved} min`;
        document.getElementById("activity-time").textContent = `${totalActivityTime} min`;
        document.getElementById("travel-time").textContent = `${totalTravelTime} min`;
        document.getElementById("total-time").textContent = `${totalTime} min`;
        document.getElementById("cost-total").textContent = `¬•${totalCost.toLocaleString()}`;
        document.getElementById("cost-jr-pass").textContent = `¬•${totalCostJR.toLocaleString()}`;
        
        // Display JR Pass recommendation
        const jrTip = document.getElementById("jr-pass-tip");
        if (isWorthIt) {
          jrTip.innerHTML = `<strong>‚úÖ JR Pass saves you ¬•${totalSavings.toLocaleString()}!</strong><br>
            <span class="text-xs">7-day pass: ¬•50,000 | Your JR fare value: ¬•${cityResults.reduce((sum, c) => sum + c.cost_estimate.jr_fares_only, 0).toLocaleString()}</span>`;
          jrTip.className = "mt-2 rounded bg-green-50 p-2 text-xs text-green-800";
        } else {
          jrTip.innerHTML = `<strong>‚ùå JR Pass costs ¬•${Math.abs(totalSavings).toLocaleString()} more</strong><br>
            <span class="text-xs">Better to pay per ride for this itinerary.</span>`;
          jrTip.className = "mt-2 rounded bg-yellow-50 p-2 text-xs text-yellow-800";
        }
        
        // Render routes by city
        const stepsContainer = document.getElementById("route-steps");
        stepsContainer.innerHTML = "";
        
        cityResults.forEach(cityData => {
          // City header
          const cityHeader = document.createElement("div");
          cityHeader.className = "font-bold text-lg text-green-800 mt-4 first:mt-0";
          cityHeader.textContent = `üèôÔ∏è ${cityData.city}`;
          stepsContainer.appendChild(cityHeader);
          
          // Route steps for this city
          cityData.route_details.forEach(step => {
            const div = document.createElement("div");
            div.className = "flex gap-3 rounded-lg bg-white p-3 shadow-sm";
            const icon = step.transport_mode === 'walk' ? 'üö∂' : 'üöÉ';
            const distKm = step.distance_km || 0;
            const warningClass = distKm > 50 ? 'text-red-600 font-bold' : 'text-slate-500';
            const warningIcon = distKm > 50 ? '‚ö†Ô∏è ' : '';
            
            div.innerHTML = `
              <div class="flex h-8 w-8 items-center justify-center rounded-full bg-green-600 text-sm font-bold text-white">${step.step}</div>
              <div class="flex-1">
                <div class="font-semibold">${step.location}</div>
                <div class="text-sm text-slate-600">${step.time_at_location} min</div>
                ${step.travel_from_previous ? `<div class="text-xs ${warningClass}">${warningIcon}${icon} ${step.travel_from_previous} min (${distKm.toFixed(2)} km)</div>` : ''}
              </div>
            `;
            stepsContainer.appendChild(div);
          });
        });
        
        panel.scrollIntoView({behavior: "smooth"});
      } catch (e) { console.error(e); alert("Route optimization failed: " + (e?.message || e)); }
    });
    document.getElementById("apply-optimized-route")?.addEventListener("click", () => { if (!optimizedRouteData) return; alert(`Optimized route:\n${optimizedRouteData.optimal_route.join(' ‚Üí ')}\n\nManually reorder to match!`); });
  </script>

  <!-- Firebase Save/Load -->
  <script type="module">
    import { auth, db } from "/static/js/firebase-init.js?v=4";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { doc, getDoc, updateDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const msg = document.getElementById("save-msg");
    const params = new URLSearchParams(location.search);
    const itineraryId = params.get("itineraryId");

    function collectPlan(){
      const cities = ["tokyo","kyoto","osaka"];
      const plan = { tokyo:[], kyoto:[], osaka:[] };
      cities.forEach(city=>{
        const boxes = document.querySelectorAll(`#${city}-days .day-box`);
        boxes.forEach((box, i) => {
          const location  = box.querySelector(`[id^="${city}-location-"]`)?.value || "";
          const activities = box.querySelector(`[id^="${city}-activities-"]`)?.value || "";
          plan[city].push({ day:i+1, location, activities });
        });
      });
      return plan;
    }

    function renderPlanMulti(p){
      const cities = ["tokyo","kyoto","osaka"];
      cities.forEach(city=>{
        const cont = document.getElementById(`${city}-days`);
        cont.innerHTML = "";
        if (window.counters) window.counters[city] = 0;

        (p?.[city] || []).forEach((d, idx)=>{
          window.addDay?.(city);
          const i = idx + 1;
          const loc = document.getElementById(`${city}-location-${i}`);
          const act = document.getElementById(`${city}-activities-${i}`);
          if (loc) loc.value = d.location || "";
          if (act) act.value = d.activities || "";
        });

        if (!p?.[city] || p[city].length === 0) window.addDay?.(city);
      });
    }

    // expose savePlan for the button
    window.savePlan = ()=>{};

    // Track current user for custom places feature
    let currentUserId = null;
    
    // Helper function to make authenticated requests
    async function authenticatedFetch(url, options = {}) {
      if (!currentUserId) {
        throw new Error("Please sign in to use this feature");
      }
      
      // Add user ID to headers
      options.headers = {
        ...options.headers,
        "X-User-ID": currentUserId
      };
      
      return fetch(url, options);
    }
    
    // Toggle custom place form
    window.toggleCustomPlaceForm = function() {
      const form = document.getElementById("custom-place-form");
      form.classList.toggle("hidden");
    };
    
    // Save custom place
    window.saveCustomPlace = async function() {
      if (!currentUserId) {
        alert("Please sign in to add custom places!");
        window.location.href = "/auth.html";
        return;
      }
      
      const placeData = {
        name: document.getElementById("custom-name").value.trim(),
        lat: parseFloat(document.getElementById("custom-lat").value),
        lng: parseFloat(document.getElementById("custom-lng").value),
        city: document.getElementById("custom-city").value,
        notes: document.getElementById("custom-notes").value.trim(),
        category: "custom"
      };
      
      // Validate
      if (!placeData.name) {
        alert("Please enter a place name");
        return;
      }
      if (isNaN(placeData.lat) || isNaN(placeData.lng)) {
        alert("Please enter valid GPS coordinates");
        return;
      }
      
      try {
        const response = await authenticatedFetch("/user/places", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(placeData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`‚úÖ "${placeData.name}" saved! Now you can use it in your itinerary.`);
          // Clear form
          document.getElementById("custom-name").value = "";
          document.getElementById("custom-lat").value = "";
          document.getElementById("custom-lng").value = "";
          document.getElementById("custom-notes").value = "";
          toggleCustomPlaceForm();
          loadUserCustomPlaces();
        } else {
          alert(`‚ùå Error: ${result.error || "Failed to save place"}`);
        }
      } catch (error) {
        console.error("Error saving custom place:", error);
        alert(`‚ùå Error: ${error.message}`);
      }
    };
    
    // Load user's custom places
    async function loadUserCustomPlaces() {
      if (!currentUserId) return;
      
      try {
        const response = await authenticatedFetch("/user/places");
        const data = await response.json();
        
        const listContainer = document.getElementById("custom-places-list");
        const itemsContainer = document.getElementById("custom-places-items");
        
        if (data.places && data.places.length > 0) {
          listContainer.classList.remove("hidden");
          itemsContainer.innerHTML = data.places.map(place => `
            <div class="rounded-lg bg-white p-3 border border-purple-200">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-medium text-purple-900">${place.name}</div>
                  <div class="text-xs text-slate-600">${place.city} ‚Ä¢ ${place.lat.toFixed(4)}, ${place.lng.toFixed(4)}</div>
                  ${place.notes ? `<div class="text-xs text-slate-500 mt-1">${place.notes}</div>` : ''}
                </div>
                <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">Custom</span>
              </div>
            </div>
          `).join('');
        } else {
          listContainer.classList.add("hidden");
        }
      } catch (error) {
        console.error("Error loading custom places:", error);
      }
    }

    onAuthStateChanged(auth, async(user)=>{
      const readyUser = user || null;
      
      // Update currentUserId for custom places
      currentUserId = readyUser ? readyUser.uid : null;
      
      // Load user's custom places if signed in
      if (currentUserId) {
        loadUserCustomPlaces();
      }
      
      if (!readyUser) return;

      if (itineraryId){
        const ref = doc(db, `users/${readyUser.uid}/itineraries/${itineraryId}`);
        const snap = await getDoc(ref);
        const data = snap.exists() ? (snap.data() || {}) : {};
        const plan = data.plan || { tokyo:[], kyoto:[], osaka:[] };
        renderPlanMulti(plan);

        window.savePlan = async ()=>{
          const newPlan = collectPlan();
          const totalDays = (newPlan.tokyo?.length||0) + (newPlan.kyoto?.length||0) + (newPlan.osaka?.length||0);
          msg.textContent = "Saving‚Ä¶";
          try {
            await updateDoc(ref, {
              plan: newPlan,
              days: totalDays,
              cities: ["Tokyo","Kyoto","Osaka"].filter(c => (newPlan[c.toLowerCase()]||[]).length>0),
              updatedAt: serverTimestamp()
            });
            alert("Changes saved.");
            msg.textContent = "Changes saved.";
          } catch(e){
            console.error(e); alert(`Save failed: ${e.message||e}`); msg.textContent = "Save failed.";
          }
        };
        // Add "Save As Copy"
        const saveBtn = document.querySelector('button[onclick="savePlan()"]');
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Save As Copy";
        copyBtn.className = "ml-2 rounded-lg bg-slate-700 px-5 py-2.5 text-white font-semibold hover:bg-black";
        saveBtn.after(copyBtn);
        copyBtn.onclick = async ()=>{
          const newPlan = collectPlan();
          const totalDays = (newPlan.tokyo?.length||0) + (newPlan.kyoto?.length||0) + (newPlan.osaka?.length||0);
          const title = prompt("Copy title?", `Tokyo + Kansai Trip (Copy ${new Date().toLocaleDateString()})`) ||
                        `Tokyo + Kansai Trip (Copy ${new Date().toLocaleDateString()})`;
          try{
            const colRef = collection(db, `users/${readyUser.uid}/itineraries`);
            await addDoc(colRef, {
              title, city: "Tokyo + Kansai", plan: newPlan, days: totalDays,
              cities: ["Tokyo","Kyoto","Osaka"].filter(c => (newPlan[c.toLowerCase()]||[]).length>0),
              createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            alert("Saved a new copy!");
          }catch(e){ console.error(e); alert(`Save-as-copy failed: ${e.message||e}`); }
        };

        return;
      }

      // CREATE MODE
      window.savePlan = async ()=>{
        const newPlan = collectPlan();
        const totalDays = (newPlan.tokyo?.length||0) + (newPlan.kyoto?.length||0) + (newPlan.osaka?.length||0);
        const title = prompt("Trip title?", `Tokyo + Kansai Trip (${new Date().toLocaleDateString()})`) ||
                      `Tokyo + Kansai Trip (${new Date().toLocaleDateString()})`;
        msg.textContent = "Saving to the cloud‚Ä¶";
        try {
          const colRef = collection(db, `users/${readyUser.uid}/itineraries`);
          await addDoc(colRef, {
            title, city: "Tokyo + Kansai", plan: newPlan, days: totalDays,
            cities: ["Tokyo","Kyoto","Osaka"].filter(c => (newPlan[c.toLowerCase()]||[]).length>0),
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          alert("Saved as a new itinerary!");
          msg.textContent = "Saved as a new itinerary.";
        } catch(e){
          console.error(e); alert(`Cloud save failed: ${e.code||""} ${e.message||e}`);
          msg.textContent = "Save failed. See console.";
        }
      };
    });
  </script>

  <!-- Load Recommendations from MongoDB -->
  <script type="module">
    async function fetchFromAPI(type, city) {
      const url = `https://japan-travel-backend-587601512996.us-central1.run.app/${type}?city=${city}&limit=500`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      const json = await res.json();
      return json.data || [];
    }

    function renderList(id, data) {
      const ul = document.getElementById(id);
      if (!ul) return;
      ul.innerHTML = '';
      (data || []).forEach(item => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = item.google_map_url || item.google_maps_url || "#";
        a.textContent = item.name || "(Unnamed)";
        a.target = "_blank";
        a.rel = "noopener";
        a.className = "text-blue-700 hover:underline";
        li.appendChild(a);
        ul.appendChild(li);
      });
    }

    (async () => {
      try {
        // Fetch data for Tokyo, Kyoto, Osaka
        const [tokyoData, kyotoData, osakaData] = await Promise.all([
          Promise.all([fetchFromAPI('attractions', 'Tokyo'), fetchFromAPI('shopping', 'Tokyo'), fetchFromAPI('restaurants', 'Tokyo'), fetchFromAPI('daytrips', 'Tokyo')]),
          Promise.all([fetchFromAPI('attractions', 'Kyoto'), fetchFromAPI('shopping', 'Kyoto'), fetchFromAPI('restaurants', 'Kyoto')]),
          Promise.all([fetchFromAPI('attractions', 'Osaka'), fetchFromAPI('shopping', 'Osaka'), fetchFromAPI('restaurants', 'Osaka'), fetchFromAPI('daytrips', 'Osaka')])
        ]);

        // TOKYO
        renderList('tokyo-attractions', tokyoData[0]);
        renderList('tokyo-shopping', tokyoData[1]);
        const tokyoRestByArea = tokyoData[2].reduce((acc, item) => { const area = (item.area || '').toLowerCase(); if (!acc[area]) acc[area] = []; acc[area].push(item); return acc; }, {});
        ['akihabara', 'asakusa', 'ginza', 'ikebukuro', 'meguro', 'roppongi', 'shibuya', 'shinjuku'].forEach(a => renderList(a + '-list', tokyoRestByArea[a] || []));
        renderList('other-area-list', tokyoRestByArea['tokyo'] || []);
        const tokyoDTByArea = tokyoData[3].reduce((acc, item) => { const area = item.area || 'Other'; if (!acc[area]) acc[area] = []; acc[area].push(item); return acc; }, {});
        ['Yokohama', 'Nikko', 'Kamakura', 'Kawagoe', 'Hakone', 'Fujimount'].forEach(a => renderList(a + '-list', tokyoDTByArea[a] || []));

        // KYOTO
        renderList('kyoto-attractions', kyotoData[0]);
        renderList('kyoto-shopping', kyotoData[1]);
        renderList('kyoto-restaurants', kyotoData[2]);

        // OSAKA
        renderList('osaka-attractions', osakaData[0]);
        renderList('osaka-shopping', osakaData[1]);
        renderList('osaka-restaurants', osakaData[2]);
        renderList('nara-list', osakaData[3].filter(d => (d.area || '').toLowerCase().includes('nara')));

        console.log('‚úÖ All Tokyo+Kansai recommendations loaded!');
      } catch (err) { console.error('‚ùå Error:', err); }
    })();
  </script>
</body>
</html>
